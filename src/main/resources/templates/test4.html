<!--
  Copyright 2019 Google LLC

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<!DOCTYPE html>
<html>

<head>
  <title>Sushi Finder</title>
<!--  <meta name="viewport" content="initial-scale=1.0, user-scalable=no">-->
  <meta charset="utf-8">
  <style>
    /* div のサイズを定義するには、常にマップの高さを明示的に設定します。 */

    /* ID:マップの記述
    画面いっぱい
    背景色　灰色

    */
    #map {
      height: 100%;
      background-color: grey;
    }

    /* オプション: サンプル ページがウィンドウいっぱいに表示されます。 */

    /* cssでボデイの指定
     画面いっぱい

     */
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    /* TODO: ステップ 4A1: 汎用サイドバーを作成します */
    /* 左側からスライドして表示される情報ペインのスタイル。
      ※デフォルトでは非表示になっています。*/

    /* ID:パネルの記述
      高さ最大
      幅　null
      背景色　白
      position: fixedは、画面から見た位置で要素を固定させたい時に使用する値です。
      重なり　1　//数値が大きいほうが画面の上に表示される
      パネル内からはみ出した要素は隠す（表示しない）
      transition: all .2s ease-out; //アニメーションの指定っぽいけど機能してない？

    */
    #panel {
      height: 100%;
      width: null;
      background-color: white;
      position: fixed;
      z-index: 1;
      overflow-x: hidden;
      transition: all .2s ease-out;
    }
    /* clase:オープンの記述
    幅　250pxを持たせる

    */
    .open {
      width: 250px;
    }

    /* 場所の詳細のスタイル設定 */

    /* class:ヒーローの記述
      幅　100％
      高さ　オート
      マックス高さ　166px
      これのブロック指定

    */
    .hero {
      width: 100%;
      height: auto;
      max-height: 166px;
      display: block;
    }
   /* class:プレイスの中のpタグの記述
    フォント　？
    要素の外の左と右の幅　？

    */
    .place,
    p {
      font-family: 'open sans', arial, sans-serif;
      padding-left: 18px;
      padding-right: 18px;
    }
    /* class:詳細ズの記述
    カラー　ダーク・ストレート・グレイ

    */
    .details {
      color: darkslategrey;
    }
    /* aタグの記述
    テキスト装飾　無し　　//aタグのアンダーラインを無くす
    カラー　カデットブルー

    */
    a {
      text-decoration: none;
      color: cadetblue;
    }
  </style>
</head>

<body>
<!-- TODO　汎用サイドバーを追加する -->
<!-- 場所の詳細を表示するスライドアウトパネル -->
<div id="panel"></div>

<!-- ここに地図が表示されます -->
<div id="map"></div>

<script>
    /* 注: この例では、次の場合に位置情報の共有に同意する必要があります。
     * ブラウザによってプロンプトが表示されます。 「位置情報の許可」というエラーが表示された場合
     * 拒否されました。」というメッセージは、ブラウザに * あなたを見つける許可を与えていない可能性があることを意味します。 */

    let pos; //現在位置
    let map; //地図
    let bounds; //地図の表示領域
    let infoWindow; //打たれたピンのウィンドウ
    let currentInfoWindow; //ウィンドウを作るやつ
    let service; //サービス
    let infoPane; //パネルの情報
    function initMap() {
      // 変数の初期化
      bounds = new google.maps.LatLngBounds(); //マップの表示領域を生成
      infoWindow = new google.maps.InfoWindow; //打たれたピンのウィンドウを生成
      currentInfoWindow = infoWindow; //currentInfoWindowにウィンドウ生成の変数を入れる
      /* 一般的なサイドバーを追加する */
      infoPane = document.getElementById('panel'); //infoPaneにID="panel"の情報を入れる

      // HTML5 geolocation (地理位置情報) を試してみる
      // アクセスされてるPCの座標を取得する
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
        //geolocationを使ってposに現在位置の座標を入れてる
          pos = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          /* 地図を表示する
           地図の中心位置はposの座標
           拡大レベル15

           */
          map = new google.maps.Map(document.getElementById('map'), {
            center: pos,
            zoom: 15
          });
          bounds.extend(pos); //地図の表示領域を現在位置にする

          infoWindow.setPosition(pos); //ウィンドウに現在位置
          infoWindow.setContent('Location found.'); //
          infoWindow.open(map);
          map.setCenter(pos);

          // Call Places Nearby Search on user's location
          getNearbyPlaces(pos);
        }, () => {
          // Browser supports geolocation, but user has denied permission
          handleLocationError(true, infoWindow);
        });
      } else {
        // Browser doesn't support geolocation
        handleLocationError(false, infoWindow);
      }
    }

    // Handle a geolocation error
    function handleLocationError(browserHasGeolocation, infoWindow) {
      // Set default location to Sydney, Australia
      pos = { lat: -33.856, lng: 151.215 };
      map = new google.maps.Map(document.getElementById('map'), {
        center: pos,
        zoom: 15
      });

      // Display an InfoWindow at the map center
      infoWindow.setPosition(pos);
      infoWindow.setContent(browserHasGeolocation ?
        'Geolocation permissions denied. Using default location.' :
        'Error: Your browser doesn\'t support geolocation.');
      infoWindow.open(map);
      currentInfoWindow = infoWindow;

      // Call Places Nearby Search on the default location
      getNearbyPlaces(pos);
    }

    // Perform a Places Nearby Search Request
    function getNearbyPlaces(position) {
      let request = {
        location: position,
<!--        rankBy: google.maps.places.RankBy.DISTANCE,-->
        radius: 1000,
<!--        keyword: 'sushi'-->
        keyword: 'らーめん'
      };

      service = new google.maps.places.PlacesService(map);
      service.nearbySearch(request, nearbyCallback);
    }

    // Handle the results (up to 20) of the Nearby Search
    function nearbyCallback(results, status) {
      if (status == google.maps.places.PlacesServiceStatus.OK) {
        createMarkers(results);
      }
    }

    // Set markers at the location of each place result
    function createMarkers(places) {
      places.forEach(place => {
        let marker = new google.maps.Marker({
          position: place.geometry.location,
          map: map,
          title: place.name
        });

        /* TODO: Step 4B: Add click listeners to the markers */
        // Add click listener to each marker
        google.maps.event.addListener(marker, 'click', () => {
          let request = {
            placeId: place.place_id,
            fields: ['name', 'formatted_address', 'geometry', 'rating',
              'website', 'photos']
          };

          /* Only fetch the details of a place when the user clicks on a marker.
           * If we fetch the details for all place results as soon as we get
           * the search response, we will hit API rate limits. */
          service.getDetails(request, (placeResult, status) => {
            showDetails(placeResult, marker, status)
          });
        });

        // Adjust the map bounds to include the location of this marker
        bounds.extend(place.geometry.location);
      });
      /* Once all the markers have been placed, adjust the bounds of the map to
       * show all the markers within the visible area. */
      map.fitBounds(bounds);
    }

    /* TODO: Step 4C: Show place details in an info window */
    // Builds an InfoWindow to display details above the marker
    function showDetails(placeResult, marker, status) {
      if (status == google.maps.places.PlacesServiceStatus.OK) {
        let placeInfowindow = new google.maps.InfoWindow();
        let rating = "None";
        if (placeResult.rating) rating = placeResult.rating;
        placeInfowindow.setContent('<div><strong>' + placeResult.name +
          '</strong><br>' + 'Rating: ' + rating + '</div>');
        placeInfowindow.open(marker.map, marker);
        currentInfoWindow.close();
        currentInfoWindow = placeInfowindow;
        showPanel(placeResult);
      } else {
        console.log('showDetails failed: ' + status);
      }
    }

    /* TODO: Step 4D: Load place details in a sidebar */
    // Displays place details in a sidebar
    function showPanel(placeResult) {
      // If infoPane is already open, close it
      if (infoPane.classList.contains("open")) {
        infoPane.classList.remove("open");
      }

      // Clear the previous details
      while (infoPane.lastChild) {
        infoPane.removeChild(infoPane.lastChild);
      }

      /* TODO: Step 4E: Display a Place Photo with the Place Details */
      // Add the primary photo, if there is one
      if (placeResult.photos) {
        let firstPhoto = placeResult.photos[0];
        let photo = document.createElement('img');
        photo.classList.add('hero');
        photo.src = firstPhoto.getUrl();
        infoPane.appendChild(photo);
      }

      // Add place details with text formatting
      let name = document.createElement('h1');
      name.classList.add('place');
      name.textContent = placeResult.name;
      infoPane.appendChild(name);
      if (placeResult.rating) {
        let rating = document.createElement('p');
        rating.classList.add('details');
        rating.textContent = `Rating: ${placeResult.rating} \u272e`;
        infoPane.appendChild(rating);
      }
      let address = document.createElement('p');
      address.classList.add('details');
      address.textContent = placeResult.formatted_address;
      infoPane.appendChild(address);
      if (placeResult.website) {
        let websitePara = document.createElement('p');
        let websiteLink = document.createElement('a');
        let websiteUrl = document.createTextNode(placeResult.website);
        websiteLink.appendChild(websiteUrl);
        websiteLink.title = placeResult.website;
        websiteLink.href = placeResult.website;
        websitePara.appendChild(websiteLink);
        infoPane.appendChild(websitePara);
      }

      // Open the infoPane
      infoPane.classList.add("open");
    }
  </script>

<!-- TODO Places ライブラリをロードする -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAbg39Llk-5ODPu6_oblgm05ieOtom0RJc&libraries=places&callback=initMap"></script>
</body>

</html>